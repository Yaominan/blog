
## 正则表达式

- 基本正则表达式 BRE集合

  - | 符号   | 作用                       |
    | ------ | -------------------------- |
    | ^      | ^abc,以abc开头的行         |
    | $      | abc$,以abc结尾的行         |
    | ^$     | 空行                       |
    | .      | 有且只有一个字符           |
    | \      | 转义字符，\.表示小数点.    |
    | *      | 匹配前一个字符0次或多次    |
    | .*     | 匹配所有                   |
    | ^.*    | 任意多个字符开头的         |
    | .*$    | 任意多个字符结尾的         |
    | [abc]  | a或b或c                    |
    | [^abc] | 不取a或b或c，除了abc的字符 |

- 扩展正则表达式ERE集合

  - | 符号   | 作用                               |
    | ------ | ---------------------------------- |
    | +      | 匹配前一个字符一次或多次           |
    | [:/]+  | 匹配括号内的：或者/一次或多次      |
    | ?      | 匹配前一个字符0或1次               |
    | \|     | 或者，同时过滤多个字符串           |
    | ()     | 分组过滤，被括起来的内容是一个整体 |
    | a(n,m) | 前一个字符最少n次，最多m次         |
    | a(n,)  | 前一个字符最少nci                  |
    | a(,m)  | 前一个字符最多m次                  |
    |        |                                    |
    |        |                                    |

## grep

擅长单纯的查找或匹配文本的内容

## sed

更适合编辑、处理匹配到的文本内容

- | 命令 |                    作用                     |
  | :--: | :-----------------------------------------: |
  |  -i  |  将修改写入磁盘,不加-i只是修改内存中的数据  |
  |  -n  | 只输出修改的内容，通常要和内置命令p一起使用 |
  |  -r  |             支持扩展正则表达式              |
  |  -e  |            多次编辑，不需要管道             |

- | 内置命令 |   作用   |
  | :------: | :------: |
  |    a     | 行后插入 |
  |    i     | 行前插入 |
  |    d     |   删除   |
  |    p     |   打印   |
  |    s     |   替换   |

eg.获取IP地址

```bash
  [root@localhost minan]# ifconfig ens33
  ens33: flags=4163<UP,BROADCAST,RUNNING,MULTICAST>  mtu 1500
          inet 192.168.10.10  netmask 255.255.255.0  broadcast 192.168.10.255
          inet6 fe80::5102:4887:698b:945e  prefixlen 64  scopeid 0x20<link>
          ether 00:0c:29:1a:46:cd  txqueuelen 1000  (Ethernet)
          RX packets 10090  bytes 855551 (835.4 KiB)
          RX errors 0  dropped 0  overruns 0  frame 0
          TX packets 4713  bytes 793026 (774.4 KiB)
          TX errors 0  dropped 0 overruns 0  carrier 0  collisions 0
  
  [root@localhost minan]# ifconfig ens33 | sed -e "2s/^.*inet//" -e "2s/net.*$//p" -n
   192.168.10.10
   
  [root@localhost minan]# ifconfig ens33
  ens33: flags=4163<UP,BROADCAST,RUNNING,MULTICAST>  mtu 1500
          inet 192.168.10.10  netmask 255.255.255.0  broadcast 192.168.10.255
          inet6 fe80::5102:4887:698b:945e  prefixlen 64  scopeid 0x20<link>
          ether 00:0c:29:1a:46:cd  txqueuelen 1000  (Ethernet)
          RX packets 8008  bytes 720357 (703.4 KiB)
          RX errors 0  dropped 0  overruns 0  frame 0
          TX packets 2474  bytes 220362 (215.1 KiB)
          TX errors 0  dropped 0 overruns 0  carrier 0  collisions 0
  
  [root@localhost minan]# ifconfig ens33 | sed  '2s/^.*inet[[:space:]]//;2s/net.*$//p' -n
  192.168.10.10  
  
  #找出系统的大版本（sed&awk）
  [root@localhost minan]# cat /etc/redhat-release 
  CentOS Linux release 7.6.1810 (Core) 
  
  [root@localhost minan]# cat /etc/redhat-release | sed 's/^.*ease[[:space:]]//' 
  7.6.1810 (Core) 
  [root@localhost minan]# cat /etc/redhat-release | sed 's/^.*ease[[:space:]]//' | awk -F "." '{print $1}'
  7
  
  #eg1去头去尾
  [root@localhost minan]# cat /etc/redhat-release 
  CentOS Linux release        fsgbksdghlskdj;7.6.1810 (Core) 
  [root@localhost minan]# sed -r 's/^.*ease[[:space:]]*//'  /etc/redhat-release | sed -r 's/([.]).*//'
  fsgbksdghlskdj;7
  
  [root@localhost minan]# cat /etc/redhat-release 
  CentOS Linux release        fsgbksdghlskdj;7.6.1810 (Core) 
  [root@localhost minan]# sed -r 's/^.*[[:space:]]*dj;//'  /etc/redhat-release | sed -r 's/([.]).*//'
  7
  
  
  [root@localhost minan]# sed -r 's/^.*[[:space:]]*dj;//'  /etc/redhat-release | sed -r 's/([^.]).*/\1/'
  7
  
  
  
  
  
  
```

eg.正则分组

```bash
  ###修改后
  [root@localhost minan]# sed -r 's/(^.)/@\1/g' test1.cfg 
  @#version=DEVEL
  @# System authorization information
  @auth --enableshadow --passalgo=sha512
  @# Use CDROM installation media
  @cdrom
  @# Use graphical install
  @graphical
  @# Run the Setup Agent on first boot
  @firstboot --enable
  @ignoredisk --only-use=sda
  
  #源文件
  [root@localhost minan]# cat test1.cfg 
  #version=DEVEL
  # System authorization information
  auth --enableshadow --passalgo=sha512
  # Use CDROM installation media
  cdrom
  # Use graphical install
  graphical
  # Run the Setup Agent on first boot
  firstboot --enable
  ignoredisk --only-use=sda
  
```

## awk

更适合格式化处理文本内容，对文本进行复杂处理

用法：awk  [option选项] '模式{动作} 模式{动作} 模式{动作} 模式{动作}'  文件

### awk基础

awk必须外层单引号，内层双引号

#### awk分隔符

awk默认以空格为分隔符，多个空格也识别为一个

awk的分隔符有两种

1. 输入分隔符，默认空格，变量名FS

```bash
  [root@localhost minan]# awk -v FS=":" '{print $1,$NF}' passwd.txt
  [root@localhost minan]# awk -F ":" '{print $1,$NF}' passwd.txt 
```

2. 输出分隔符，OFS
```bash
  [root@localhost minan]# awk -F ":" -v OFS="------" '{print $1,$NF}' passwd.txt 
  root------/bin/bash
  bin------/sbin/nologin
  daemon------/sbin/nologin
  adm------/sbin/nologin
  lp------/sbin/nologin
  [root@localhost minan]# awk -F ":" -v OFS="\t------" '{print $1,$NF}' passwd.txt 
  root	------/bin/bash
  bin	------/sbin/nologin
  daemon	------/sbin/nologin
  adm	------/sbin/nologin
  lp	------/sbin/nologin
```

3. 换行符ORS(输出)/RS(输入)

```bash
  [root@localhost minan]# awk -F ":" -v ORS="\t/作者:minan\n" -v OFS="\t------" '{print $1,$NF}' passwd.txt 
  root	------/bin/bash	/作者:minan
  bin	------/sbin/nologin	/作者:minan
  daemon	------/sbin/nologin	/作者:minan
  adm	------/sbin/nologin	/作者:minan
  lp	------/sbin/nologin	/作者:minan
  
  
```


#### awk变量

$0:整行

$NF:当前分割后的最后一列

$(NF-1):倒数第二列

内置变量

- | 内置变量        | 解释                                                     |
  | --------------- | -------------------------------------------------------- |
  | $n              | 指定分隔符后的第n个字段                                  |
  | $0              | 完整的输入记录                                           |
  | FS              | 字段分隔符，默认是空格                                   |
  | NF              | 分割后，当前行共有的字段数                               |
  | NR              | 当前记录数，行数                                         |
  | OFS             | 输出分隔符                                               |
  | RS              | 输入记录分隔符（输入换行符），指定输入时的换行符         |
  | ORS             | 输出记录分隔符（输出换行符），输出时用指定符号代替换行符 |
  | FILENAME        | 当前文件名                                               |
  | ARGC            | 命令行参数的个数                                         |
  | ARGV            | 数组，保存的是命令行所给的参数                           |
  | 更多查看man手册 | man awk                                                  |

- ARGC&ARGV

```bash
  [root@localhost minan]# awk -v ORS="\tauthor:minan\n" 'BEGIN{print "lets go>>>>>>>>"}  NR==1{print "当前共有"ARGC"个参数","1:"ARGV[0],"2:"ARGV[1]}' test.cfg
  lets go>>>>>>>>	author:minan
  当前共有2个参数 1:awk 2:test.cfg	author:minan
  
```

自定义变量awk -v

```bash
  [root@localhost minan]# awk -v MA="minan" 'BEGIN{print "My name is "MA}'
  My name is minan
```


awk参数

- | 参数 | 解释                        |
  | ---- | --------------------------- |
  | -F   | 指定分隔符                  |
  | -v   | 定义或修改一个awk的内部变量 |
  | -f   | 从脚本文件中读取awk命令     |

#### awk格式化输出

- print
- printf

1. 与print不同，printf 需要指定format

2. format用于指定后面每个item的输出格式

3. printf不会自动打印换行符，需要添加换行符\n

   > ```bash
   > format格式的指示符都以%开头，后面跟一个字符：
   > %c：显示字符的ASCII码
   > %d,%i：十进制整数
   > %e,%E：科学计数法显示数值
   > %f：显示浮点数
   > %g,%G：以科学计数法的格式或浮点数的格式显示数值
   > %s：显示字符串
   > %u：无符号整数
   > %%：显示%自身
   > 
   > printf修饰符：
   > -：左对齐；默认右对齐
   > +：显示数值符号，如printf  "%+d"
   > ```

```bash
   [root@localhost minan]# awk -v ORS="\tauthor:minan\n" 'BEGIN{print "lets go>>>>>>>>"}  NR==1{printf "当前共有%d个参数:\n1:\t%s\n2:\t%s\n",ARGC,ARGV[0],ARGV[1]}' test.cfg
   lets go>>>>>>>>	author:minan
   当前共有2个参数:
   1:	awk
   2:	test.cfg
```


#### awk模式

- 空模式匹配每一行进行处理

- BEGIN模式：处理文本之前需要执行的动作

```bash
    [root@localhost minan]# awk -v ORS="\tauthor:minan\n" 'BEGIN{print "lets go>>>>>>>>"}  NR==1{print "当前共有"ARGC"个参数","1:"ARGV[0],"2:"ARGV[1]}' test.cfg
    lets go>>>>>>>>	author:minan
    当前共有2个参数 1:awk 2:test.cfg	author:minan
```

- END模式：处理完所有的行之后需要执行的动作

```bash
    [root@localhost minan]# awk -v ORS="\tauthor:minan\n" 'END{print "lets go>>>>>>>>"}  NR==1{print "当前共有"ARGC"个参数","1:"ARGV[0],"2:"ARGV[1]}' test.cfg
    当前共有2个参数 1:awk 2:test.cfg	author:minan
    lets go>>>>>>>>	author:minan
```

eg1.获取IP地址

```bash
  [root@localhost minan]# ifconfig ens33 | sed "2p" -n
          inet 192.168.10.10  netmask 255.255.255.0  broadcast 192.168.10.255
  [root@localhost minan]# ifconfig ens33 | sed "2p" -n | awk '{print $2}'
  192.168.10.10
```

eg2.获取IP地址

```bash
  [root@localhost minan]# ifconfig ens33 
  ens33: flags=4163<UP,BROADCAST,RUNNING,MULTICAST>  mtu 1500
          inet 192.168.10.10  netmask 255.255.255.0  broadcast 192.168.10.255
          inet6 fe80::5102:4887:698b:945e  prefixlen 64  scopeid 0x20<link>
          ether 00:0c:29:1a:46:cd  txqueuelen 1000  (Ethernet)
          RX packets 14888  bytes 1255714 (1.1 MiB)
          RX errors 0  dropped 0  overruns 0  frame 0
          TX packets 7031  bytes 1068364 (1.0 MiB)
          TX errors 0  dropped 0 overruns 0  carrier 0  collisions 0
  
  [root@localhost minan]# ifconfig ens33 | awk 'NR==2{print $2}'
  192.168.10.10
```

#### awk正则表达

```bash
awk  -F   ":"   '/pattern/{动作}'

# 找出games开头的行

  [root@localhost minan]# awk '/^game/{print}' passwd.txt 
  games:x:12:100:games:/usr/games:/sbin/nologin

# 只输出第一列和最后一列

  [root@localhost minan]# awk -F ":" '/game/{print $1,$NF}' passwd.txt 
  games /sbin/nologin

# 格式化输出


  [root@localhost minan]# awk -F ":" 'BEGIN{printf "%-15s\t %-15s\t %-15s\t %-15s\t\n","用户名","用户id","用户家目录","用户解释器"}/^game/{printf "%-20s\t %-20s\t %-20s\t %-20s\t\n",$1,$3,$(NF-1),$NF}' passwd.txt 
  用户名            	 用户id           	 用户家目录          	 用户解释器          	
  games               	 12                  	 /usr/games          	 /sbin/nologin
  
  [root@localhost minan]# awk -F ":" 'BEGIN{printf "%-15s\t %-15s\t %-15s\t %-15s\t\n","用户名","用户id","用户家目录","用户解释器"}{printf "%-20s\t %-20s\t %-20s\t %-20s\t\n",$1,$3,$(NF-1),$NF}' passwd.txt | head -n5
  用户名            	 用户id           	 用户家目录          	 用户解释器          	
  root                	 0                   	 /root               	 /bin/bash           	
  bin                 	 1                   	 /bin                	 /sbin/nologin       	
  daemon              	 2                   	 /sbin               	 /sbin/nologin       	
  adm                 	 3                   	 /var/adm            	 /sbin/nologin   

# 找出指定行满足条件的内容

  [root@localhost minan]# awk -F ":" '/^operator/,/^chrony/{print NR,$1,$NF}' passwd.txt 
  10 operator /sbin/nologin
  11 games /sbin/nologin
  12 ftp /sbin/nologin
  13 nobody /sbin/nologin
  14 systemd-network /sbin/nologin
  15 dbus /sbin/nologin
  16 polkitd /sbin/nologin
  17 libstoragemgmt /sbin/nologin
  18 colord /sbin/nologin
  19 rpc /sbin/nologin
  20 gluster /sbin/nologin
  21 saslauth /sbin/nologin
  22 abrt /sbin/nologin
  23 rtkit /sbin/nologin
  24 pulse /sbin/nologin
  25 radvd /sbin/nologin
  26 rpcuser /sbin/nologin
  27 nfsnobody /sbin/nologin
  28 unbound /sbin/nologin
  29 chrony /sbin/nologin
```

### awk案例

获取访问网站频率最高的IP

```bash
  [root@localhost httpd]# awk '{print $1}' access_log-20221120 | sort -n| uniq
  192.168.10.1
  192.168.10.100
  192.168.10.101
  [root@localhost httpd]# awk '{print $1}' access_log-20221120 | sort -n| uniq -c
       18 192.168.10.1
     2797 192.168.10.100
     2797 192.168.10.101
  [root@localhost httpd]# awk '{print $1}' access_log-20221120 | sort -n| uniq -c| sort -n
       18 192.168.10.1
     2797 192.168.10.100
     2797 192.168.10.101
  [root@localhost httpd]# awk '{print $1}' access_log-20221120 | sort -n| uniq -c| sort -nr
     2797 192.168.10.101
     2797 192.168.10.100
       18 192.168.10.1
  [root@localhost httpd]# awk '{print $1}' access_log-20221120 | sort -n| uniq -c| sort -nr | head -2
     2797 192.168.10.101
     2797 192.168.10.100
```

匹配整个单词

```bash
  [root@localhost minan]# grep -E "^(minan|minayao)" passwd.txt 
  minayao:x:1000:1000:minayao:/home/minayao:/bin/bash
  minayao1:x:1001:1001::/home/minayao1:/bin/bash
  minayao2:x:1002:1002::/home/minayao2:/bin/bash
  minan:x:1003:1003::/home/minan:/bin/bash
  minan1:x:1004:1004::/home/minan1:/bin/bash
  minan2:x:1005:1005::/home/minan2:/bin/bash
  
  [root@localhost minan]# grep -E "^(minan|minayao)" passwd.txt -w
  minayao:x:1000:1000:minayao:/home/minayao:/bin/bash
  minan:x:1003:1003::/home/minan:/bin/bash
  
  [root@localhost minan]# grep -E "^(minan|minayao)\>" passwd.txt 
  minayao:x:1000:1000:minayao:/home/minayao:/bin/bash
  minan:x:1003:1003::/home/minan:/bin/bash
  
```
